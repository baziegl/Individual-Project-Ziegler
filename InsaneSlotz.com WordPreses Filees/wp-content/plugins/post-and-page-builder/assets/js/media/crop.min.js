var BOLDGRID=BOLDGRID||{};BOLDGRID.EDITOR=BOLDGRID.EDITOR||{},BOLDGRID.EDITOR.Crop=function(t){var e=this;e.modal,e.selectedCoordinates=null,e.newImage=!1,e.oldImage=!1,this.modalClear=function(){e.$mediaModal.css("display","block"),e.$modalContent.empty(),e.$modalToolbar.empty();var t=wp.template("suggest-crop-compare");e.$modalContent.html(t())},this.crop=function(){e.$skipButton.prop("disabled",!0),e.$primaryButton.prop("disabled",!0).text("Cropping...");var o={action:"suggest_crop_crop",cropDetails:e.selectedCoordinates,path:e.$selectDimensions.find("option:selected").val(),originalWidth:t(e.oldImage)[0].naturalWidth,originalHeight:t(e.oldImage)[0].naturalHeight,id:e.$selectDimensions.attr("data-id")};t.post(ajaxurl,o,function(t){e.cropValidate(t)})},this.cropInvalid=function(){var o=wp.template("suggest-crop-invalid");e.$modalToolbar.html(o()),t("button.crop-fail").on("click",function(){e.modal.close()})},this.cropValidate=function(o){if("0"!==o){try{o=JSON.parse(o)}catch(t){return void e.cropInvalid()}var i=!0;t.each(["new_image_height","new_image_width","new_image_url"],function(t,e){if(void 0===o[e])return i=!1,!1}),i?e.cropValid(o):e.cropInvalid()}else e.cropInvalid()},this.cropValid=function(o){var i=tinyMCE.activeEditor.selection.getNode();i.src=o.new_image_url,i.width=o.new_image_width,i.height=o.new_image_height,i.setAttribute("data-mce-src",o.new_image_url),e.$skipButton.prop("disabled",!1),e.$primaryButton.prop("disabled",!1).text(t(this).attr("data-default-text")),e.modal.close()},this.setImages=function(o){var i=new Image,a=new Image,n=wp.template("suggest-crop-sizes"),d={action:"suggest_crop_get_dimensions",attachment_id:o.attachment_id,originalWidth:o.customWidth,originalHeight:o.customHeight};jQuery.post(ajaxurl,d,function(d){if("0"===d)return e.modal.close(),!1;try{d=JSON.parse(d)}catch(t){return e.modal.close(),!1}e.$selectDimensions=t(n(d)),e.$selectDimensions.attr("data-id",o.attachment_id),i.onload=function(){e.oldImage=i,e.selectBestFit(),a.onload=function(){e.newImage=a,e.compareImages()},a.src=e.bestSizeSelector},i.src=o.originalUrl})},this.selectBestFit=function(){var o;1===(o=1>parseFloat(e.oldImage.width/e.oldImage.height)?e.$selectDimensions.find("option").filter(function(){return t(this).attr("data-height")>=e.oldImage.height}):e.$selectDimensions.find("option").filter(function(){return t(this).attr("data-width")>=e.oldImage.width})).length?e.bestSizeSelector=o.eq(0).val():0===o.length?e.bestSizeSelector=e.$selectDimensions.find("option").last().val():e.bestSizeSelector=o.eq(1).val(),e.$selectDimensions.find('option[value="'+e.bestSizeSelector+'"]').prop("selected",!0)},this.selectCoordinates=function(){e.setDefaultCoordinates(e.oldImage.width,e.oldImage.height,e.newImage.width,e.newImage.height),e.ias=e.$suggestCrop.imgAreaSelect({aspectRatio:e.defaultCoordinates.aspectRatio,handles:!0,imageHeight:e.newImage.height,imageWidth:e.newImage.width,instance:!0,keys:!0,persistent:!0,parent:e.$modalContent.find(".container-crop .left"),x1:e.defaultCoordinates.x1,y1:e.defaultCoordinates.y1,x2:e.defaultCoordinates.x2,y2:e.defaultCoordinates.y2,onInit:function(t,o){e.setSelectedCoordinates(t,o)},onSelectEnd:function(t,o){e.setSelectedCoordinates(t,o)}})},this.init=function(){},this.onReplace=function(t){e.modalOpen(),e.setImages(t)},this.onResize=function(){e.$modalContent.is(":visible")&&e.ias.setOptions({imageHeight:e.newImage.naturalHeight,imageWidth:e.newImage.naturalWidth,x1:e.selectedCoordinates.x1,y1:e.selectedCoordinates.y1,x2:e.selectedCoordinates.x2,y2:e.selectedCoordinates.y2})},this.onSize=function(o){var i;e.$suggestCrop.off("load").attr("src",o).on("load",function(){i=t(this)[0],img1Width=e.oldImage.width,img1Height=e.oldImage.height,img2Width=i.naturalWidth,img2Height=i.naturalHeight,e.setDefaultCoordinates(img1Width,img1Height,img2Width,img2Height),e.ias.setOptions({aspectRatio:e.defaultCoordinates.aspectRatio,imageHeight:i.naturalHeight,imageWidth:i.naturalWidth,x1:e.defaultCoordinates.x1,y1:e.defaultCoordinates.y1,x2:e.defaultCoordinates.x2,y2:e.defaultCoordinates.y2}),e.setSelectedCoordinates(null,{height:i.naturalHeight,width:i.naturalWidth,x1:e.defaultCoordinates.x1,y1:e.defaultCoordinates.y1,x2:e.defaultCoordinates.x2,y2:e.defaultCoordinates.y2}),e.$modalContent.find('[name="force-aspect-ratio"]').prop("checked",!0)})},this.modalCreate=function(){e.modal=wp.media({id:"crop",title:"Crop Image",button:{text:"Crop Image"}}),e.modal.on("close",function(){e.modal.remove(),t("#crop").closest('[id*="wp-uploader-id"]').remove(),delete e.modal}),e.modal.open(),e.$mediaModal=t(".media-modal").last(),e.$modalContent=e.$mediaModal.find(".media-frame-content",".media-modal"),e.$modalToolbar=e.$mediaModal.find(".media-frame-toolbar",".media-modal"),t(window).resize(function(){e.onResize()})},this.modalOpen=function(){if(e.modal)return e.modal.open(),void e.modalClear();e.modalCreate(),e.modalClear()},this.onMatch=function(){var t=wp.template("suggest-crop-match");e.$modalContent.html(t()),setTimeout(function(){e.$mediaModal.fadeOut("1000",function(){e.modal.close()})},1e3)},this.modalFill=function(){var o={oldImageSrc:e.oldImage.src,newImageSrc:e.newImage.src,newContentSrc:e.bestSizeSelector},i=wp.template("suggest-crop");e.$modalContent.html(i(o)),e.$suggestCrop=e.$modalContent.find(".suggest-crop"),t(".imgedit-group.imgedit-source p").last().html(e.$selectDimensions),e.$selectDimensions.on("change",function(){var o=t(this).val();e.onSize(o)});i=wp.template("suggest-crop-toolbar");e.$modalToolbar.html(i()),e.bindModal(),e.selectCoordinates()},this.setSelectedCoordinates=function(t,o){e.selectedCoordinates=o},this.setDefaultCoordinates=function(t,o,i,a){var n,d,l={};n=i,d=o*i/t,l.x1=0,l.y1=(a-d)/2,l.x2=n,l.y2=l.y1+d,d>a&&(d=a,n=t*a/o,l.x1=(i-n)/2,l.y1=0,l.x2=l.x1+n,l.y2=d),l.aspectRatio=n+":"+d,e.defaultCoordinates=l},this.compareImages=function(){e.oldImage.width/e.oldImage.height==e.newImage.width/e.newImage.height?e.onMatch():e.modalFill()},this.bindModal=function(){t(".imgedit-help-toggle").on("click",function(){t(".imgedit-help").slideToggle()}),e.bindRatio(),e.$primaryButton=e.$modalToolbar.find(".button-primary"),e.$primaryButton.attr("disabled",!1),e.$primaryButton.on("click",function(){e.crop()}),e.$skipButton=e.$primaryButton.siblings(".media-button-skip"),e.$skipButton.on("click",function(){e.modal.close()})},this.bindRatio=function(){var o=e.$modalContent.find('[name="force-aspect-ratio"]');e.$modalContent.find("span#toggle-force").on("click",function(){o.click()}),o.off("change"),o.on("change",function(){t(this).is(":checked")?e.ias.setOptions({aspectRatio:e.defaultCoordinates.aspectRatio,x1:e.defaultCoordinates.x1,y1:e.defaultCoordinates.y1,x2:e.defaultCoordinates.x2,y2:e.defaultCoordinates.y2}):e.ias.setOptions({aspectRatio:!1})})}},BOLDGRID.EDITOR.CropInstance=new BOLDGRID.EDITOR.Crop(jQuery);